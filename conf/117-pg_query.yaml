pg_query:
  name: pg_query
  desc: PostgreSQL Query metrics, require pg_stat_statements installed in schema monitor, normal version
  query: |
    SELECT queryid                                      AS query,
           sum(calls)                                   AS calls,
           sum(total_time)                              AS total_time,
           avg(min_time)                                AS min_time,
           avg(max_time)                                AS max_time,
           avg(mean_time)                               AS mean_time,
           avg(stddev_time)                             AS stddev_time,
           sum(rows)                                    AS rows,
           sum(shared_blks_hit)                         AS shared_blks_hit,
           sum(shared_blks_read)                        AS shared_blks_read,
           sum(shared_blks_read) + sum(shared_blks_hit) AS shared_blks_access,
           sum(shared_blks_dirtied)                     AS shared_blks_dirtied,
           sum(shared_blks_written)                     AS shared_blks_written,
           sum(blk_read_time)                           AS blk_read_time,
           sum(blk_write_time)                          AS blk_write_time
    FROM monitor.pg_stat_statements s
    WHERE calls > 4096
    GROUP BY queryid
    ORDER BY total_time DESC
    LIMIT 32;

  ttl: 100
  timeout: 2
  tags: [cluster, extension:pg_stat_statements , schema:monitor, not:shard, not:olap]
  min_version: 090400

  metrics:
    - query:
        usage: LABEL
        description: query identifier, bigint
    - calls:
        usage: COUNTER
        description: times been executed
    - total_time:
        usage: COUNTER
        description: Total time spent in the statement, in µs
    - min_time:
        usage: GAUGE
        description: Minimum time spent in the statement, in µs
    - max_time:
        usage: GAUGE
        description: Maximum time spent in the statement, in µs
    - mean_time:
        usage: GAUGE
        description: Mean time spent in the statement, in µs
    - stddev_time:
        usage: GAUGE
        description: Population standard deviation of time spent in the statement, in µs
    - rows:
        usage: COUNTER
        description: rows retrieved or affected by the statement
    - shared_blks_hit:
        usage: COUNTER
        description: shared block cache hits by the statement
    - shared_blks_read:
        usage: COUNTER
        description: shared blocks read by the statement
    - shared_blks_access:
        usage: COUNTER
        description: shared blocks accessed by the statement
    - shared_blks_dirtied:
        usage: COUNTER
        description: shared blocks dirtied by the statement
    - shared_blks_written:
        usage: COUNTER
        description: shared blocks written by the statement
    - blk_read_time:
        usage: COUNTER
        description: time spent reading blocks, in µs (if track_io_timing is enabled)
    - blk_write_time:
        usage: COUNTER
        description: time spent writing blocks, in µs (if track_io_timing is enabled)




pg_query_shard:
  name: pg_query
  desc: PostgreSQL Query metrics, require pg_stat_statements installed in schema monitor, shard version
  query: |
    SELECT queryid                                      AS query,
           sum(calls)                                   AS calls,
           sum(total_time)                              AS total_time,
           avg(min_time)                                AS min_time,
           avg(max_time)                                AS max_time,
           avg(mean_time)                               AS mean_time,
           avg(stddev_time)                             AS stddev_time,
           sum(rows)                                    AS rows,
           sum(shared_blks_hit)                         AS shared_blks_hit,
           sum(shared_blks_read)                        AS shared_blks_read,
           sum(shared_blks_read) + sum(shared_blks_hit) AS shared_blks_access,
           sum(shared_blks_dirtied)                     AS shared_blks_dirtied,
           sum(shared_blks_written)                     AS shared_blks_written,
           sum(blk_read_time)                           AS blk_read_time,
           sum(blk_write_time)                          AS blk_write_time
    FROM monitor.pg_stat_statements s
    WHERE calls > 64 AND query ~ (SELECT min(nspname) FROM pg_namespace WHERE nspname LIKE 'rel_8192_%' LIMIT 1)
    GROUP BY queryid
    ORDER BY total_time DESC
    LIMIT 32;

  ttl: 200
  timeout: 3
  tags: [cluster, extension:pg_stat_statements , schema:monitor, shard, not:olap]
  min_version: 090400

  metrics:
    - query:
        usage: LABEL
        description: query identifier, bigint
    - calls:
        usage: COUNTER
        description: times been executed
    - total_time:
        usage: COUNTER
        description: Total time spent in the statement, in µs
    - min_time:
        usage: GAUGE
        description: Minimum time spent in the statement, in µs
    - max_time:
        usage: GAUGE
        description: Maximum time spent in the statement, in µs
    - mean_time:
        usage: GAUGE
        description: Mean time spent in the statement, in µs
    - stddev_time:
        usage: GAUGE
        description: Population standard deviation of time spent in the statement, in µs
    - rows:
        usage: COUNTER
        description: rows retrieved or affected by the statement
    - shared_blks_hit:
        usage: COUNTER
        description: shared block cache hits by the statement
    - shared_blks_read:
        usage: COUNTER
        description: shared blocks read by the statement
    - shared_blks_access:
        usage: COUNTER
        description: shared blocks accessed by the statement
    - shared_blks_dirtied:
        usage: COUNTER
        description: shared blocks dirtied by the statement
    - shared_blks_written:
        usage: COUNTER
        description: shared blocks written by the statement
    - blk_read_time:
        usage: COUNTER
        description: time spent reading blocks, in µs (if track_io_timing is enabled)
    - blk_write_time:
        usage: COUNTER
        description: time spent writing blocks, in µs (if track_io_timing is enabled)

