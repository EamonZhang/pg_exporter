#-------------------------------------------------------------#
# pg_standby
# wal receiver stat
#-------------------------------------------------------------#

pg_standby:
  query: |
    SELECT pid,
      slot_name,
      receive_start_lsn - '0/0'                 AS init_lsn,
      receive_start_tli                         AS init_tli,
      received_lsn - '0/0'                      AS last_lsn,
      received_tli                              AS last_tli,
      extract(EPOCH FROM last_msg_send_time)    AS send_ts,
      extract(EPOCH FROM last_msg_receipt_time) AS receive_ts,
      latest_end_lsn - '0/0'                    AS report_lsn,
      extract(EPOCH FROM latest_end_time)       AS report_ts
    FROM pg_stat_wal_receiver;

  ttl: 10
  tags: [cluster]
  min_version: 100000
  max_version: 130000
  metrics:
    - pid:
        usage: LABEL
        description: pid of receiver process, unique pk
    - slot_name:
        usage: LABEL
        description: slot name of this standby server, if using
    - init_lsn:
        usage: COUNTER
        description: first time received lsn
    - init_tli:
        usage: GAUGE
        description: first time received timeline number
    - last_lsn:
        usage: COUNTER
        description: latest lsn that already flushed to standby disk
    - last_tli:
        usage: GAUGE
        description: latest timeline that already flushed to standby disk
    - send_ts:
        usage: GAUGE
        description: timestamp of sender sending last message
    - receive_ts:
        usage: GAUGE
        description: timestamp of receiving last message
    - report_lsn:
        usage: COUNTER
        description: lsn that already reporting to sender
    - report_ts:
        usage: GAUGE
        description: timestamp of last time reporting to sender

