#-------------------------------------------------------------#
# pg_vacuuming
# pg_stat_progress_vacuum, since PostgreSQL 9.6
#-------------------------------------------------------------#

pg_vacuuming:
  query: |
    SELECT pid,
           datname,
           relid,
           relname,
           phase,
           CASE WHEN heap_blks_total > 0 THEN 1.0 * heap_blks_vacuumed / heap_blks_total ELSE 0 END AS progress
    FROM pg_stat_progress_vacuum pspv,
         LATERAL (SELECT relname FROM pg_class c WHERE c.oid = pspv.relid) n;

  ttl: 10
  tags: [cluster, skip_errors]
  min_version: 090600
  skip_errors: true
  metrics:
    - datname:
        usage: LABEL
        description: database name
    - pid:
        usage: LABEL
        description: process id of indexing table
    - relid:
        usage: DISCARD
        description: relation id of indexed table
    - relname:
        usage: LABEL
        description: relation name of indexed table
    - phase:
        usage: LABEL
        description: index building phase
    - progress:
        usage: GAUGE
        description: the actual progress
