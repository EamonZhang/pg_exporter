#-------------------------------------------------------------#
# pg_slot
# replication slots
# https://www.postgresql.org/docs/12/view-pg-replication-slots.html
# 9.4 has 9 fields: slot_name, plugin, slot_type, datoid, database, active, xmin, catalog_xmin, restart_lsn
# 9.5 add 1: active_pid
# 9.6 add 1: confirmed_flush_lsn
# 10  add 1: temporary
# 10 - 12 : fixed 12 fields
#-------------------------------------------------------------#

#-------------------------------------------------------------#
# pg_slot branch 10+
#-------------------------------------------------------------#
pg_slot_10:
  name: pg_slot
  query: |
    SELECT slot_name,
      database                    AS datname,
      active,
      temporary,
      xmin::TEXT::BIGINT          AS xmin,
      catalog_xmin::TEXT::BIGINT  AS catalog_xmin,
      restart_lsn - '0/0'         AS restart_lsn,
      confirmed_flush_lsn - '0/0' AS confirm_lsn,
      CASE WHEN pg_is_in_recovery()
      THEN pg_last_wal_replay_lsn()
      ELSE pg_current_wal_lsn() END - restart_lsn
      AS retained_bytes
    FROM pg_replication_slots;

  ttl: 10
  tags: [cluster]
  min_version: 100000
  skip_errors: true
  metrics:
    - slot_name:
        usage: LABEL
        description: replication slot name
    - datname:
        usage: LABEL
        description: associated database name, only logical slot have this
    - active:
        usage: GAUGE
        description: whether the slot is currently being used
    - temporary:
        usage: GAUGE
        description: whether the slot is a temporary replication slot
    - xmin:
        usage: GAUGE
        description: oldest txid that this slot needs the database to retain
    - catalog_xmin:
        usage: GAUGE
        description: oldest txid that this slot needs the database to retain for catalog
    - restart_lsn:
        usage: COUNTER
        description: lsn that needs retain, wal after that will be kept
    - confirm_lsn:
        usage: COUNTER
        description: lsn that confirmed by logical standby, null for physical slot
    - retained_bytes:
        usage: GAUGE
        description: bytes retained for this slot

#-------------------------------------------------------------#
# pg_slot branch 9.6
# remove temporary
#-------------------------------------------------------------#
pg_slot_96:
  name: pg_slot
  query: |
    SELECT slot_name,
      database                    AS datname,
      active,
      xmin::TEXT::BIGINT          AS xmin,
      catalog_xmin::TEXT::BIGINT  AS catalog_xmin,
      restart_lsn - '0/0'         AS restart_lsn,
      confirmed_flush_lsn - '0/0' AS confirm_lsn,
      CASE WHEN pg_is_in_recovery()
      THEN pg_last_wal_replay_lsn()
      ELSE pg_current_wal_lsn() END - restart_lsn
      AS retained_bytes
    FROM pg_replication_slots;

  ttl: 10
  tags: [cluster]
  min_version: 090600
  max_version: 100000
  skip_errors: true
  metrics:
    - slot_name:
        usage: LABEL
        description: replication slot name
    - datname:
        usage: LABEL
        description: associated database name, only logical slot have this
    - active:
        usage: GAUGE
        description: whether the slot is currently being used
    - xmin:
        usage: GAUGE
        description: oldest txid that this slot needs the database to retain
    - catalog_xmin:
        usage: GAUGE
        description: oldest txid that this slot needs the database to retain for catalog
    - restart_lsn:
        usage: COUNTER
        description: lsn that needs retain, wal after that will be kept
    - confirm_lsn:
        usage: COUNTER
        description: lsn that confirmed by logical standby, null for physical slot
    - retained_bytes:
        usage: GAUGE
        description: bytes retained for this slot


#-------------------------------------------------------------#
# pg_slot branch 9.4
# remove active_pid, confirmed_flush_lsn
#-------------------------------------------------------------#
pg_slot_94:
  name: pg_slot
  query: |
    SELECT slot_name,
      database                    AS datname,
      active,
      xmin::TEXT::BIGINT          AS xmin,
      catalog_xmin::TEXT::BIGINT  AS catalog_xmin,
      restart_lsn - '0/0'         AS restart_lsn,
      CASE WHEN pg_is_in_recovery()
      THEN pg_last_wal_replay_lsn()
      ELSE pg_current_wal_lsn() END - restart_lsn
      AS retained_bytes
    FROM pg_replication_slots;

  ttl: 10
  tags: [cluster]
  min_version: 090400
  max_version: 090600
  skip_errors: true
  metrics:
    - slot_name:
        usage: LABEL
        description: replication slot name
    - datname:
        usage: LABEL
        description: associated database name, only logical slot have this
    - active:
        usage: GAUGE
        description: whether the slot is currently being used
    - xmin:
        usage: GAUGE
        description: oldest txid that this slot needs the database to retain
    - catalog_xmin:
        usage: GAUGE
        description: oldest txid that this slot needs the database to retain for catalog
    - restart_lsn:
        usage: COUNTER
        description: lsn that needs retain, wal after that will be kept
    - retained_bytes:
        usage: GAUGE
        description: bytes retained for this slot
